# Streamlit ëŒ€ì‹œë³´ë“œ ì•„í‚¤í…ì²˜

## ëª©ì°¨

- [ì „ì²´ êµ¬ì¡°](#ì „ì²´-êµ¬ì¡°)
- [ë°ì´í„° íë¦„](#ë°ì´í„°-íë¦„)
- [ëª¨ë“ˆ ìƒì„¸](#ëª¨ë“ˆ-ìƒì„¸)
- [ìºì‹± ì „ëµ](#ìºì‹±-ì „ëµ)
- [ì„±ëŠ¥ ìµœì í™”](#ì„±ëŠ¥-ìµœì í™”)
- [í™•ì¥ ê°€ì´ë“œ](#í™•ì¥-ê°€ì´ë“œ)

---

## ì „ì²´ êµ¬ì¡°

### ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Browser (User)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      app.py (Main App)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Sidebar     â”‚  â”‚   Header     â”‚  â”‚ Main Content â”‚      â”‚
â”‚  â”‚  Navigation  â”‚  â”‚ Month Select â”‚  â”‚  Page Router â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Monthly    â”‚ â”‚   Account    â”‚ â”‚    Total     â”‚
â”‚  Comparison  â”‚ â”‚  Portfolio   â”‚ â”‚  Portfolio   â”‚
â”‚   (Page)     â”‚ â”‚    (Page)    â”‚ â”‚    (Page)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      data_loader.py           â”‚
        â”‚  (Cached Data Functions)      â”‚
        â”‚  @st.cache_data decorators    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Charts     â”‚ â”‚   Utils      â”‚ â”‚   Config     â”‚
â”‚  (Plotly)    â”‚ â”‚ (Formatters) â”‚ â”‚  (Settings)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  portfolio.db â”‚
                â”‚   (SQLite)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë°ì´í„° íë¦„

### 1. ì•± ì‹œì‘ (app.py)

```python
1. í˜ì´ì§€ ì„¤ì • (set_page_config)
2. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (init_session_state)
3. ì‚¬ì´ë“œë°” ë Œë”ë§ (í˜ì´ì§€ ì„ íƒ)
4. ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ ë Œë”ë§
5. ì„ íƒëœ í˜ì´ì§€ ë¼ìš°íŒ…
```

### 2. í˜ì´ì§€ ë Œë”ë§

```python
# ì˜ˆ: ì›”ë³„ íˆ¬ì ë¹„êµ í˜ì´ì§€
monthly_comparison.render(selected_month)
    â†“
get_monthly_summary(selected_month)  # ìºì‹œë¨
    â†“
SQLite DB ì¿¼ë¦¬ (ìºì‹œ ë¯¸ìŠ¤ ì‹œ)
    â†“
ë°ì´í„° ë°˜í™˜ (dict)
    â†“
Streamlit ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ (st.metric, st.plotly_chart ë“±)
```

### 3. ìºì‹œ íˆíŠ¸ ì‹œ

```python
get_monthly_summary(selected_month)
    â†“
@st.cache_data ì²´í¬
    â†“
ìºì‹œ íˆíŠ¸ â†’ DB ì¿¼ë¦¬ ìƒëµ
    â†“
ì¦‰ì‹œ ë°ì´í„° ë°˜í™˜
```

---

## ëª¨ë“ˆ ìƒì„¸

### config.py

**ì—­í• :** ì „ì—­ ì„¤ì • ê´€ë¦¬

**ì£¼ìš” ìƒìˆ˜:**
```python
PAGE_TITLE = "í¬íŠ¸í´ë¦¬ì˜¤ ëŒ€ì‹œë³´ë“œ"
PAGE_ICON = "ğŸ’°"
LAYOUT = "wide"

COLORS = {
    'STOCK': '#3498db',
    'BOND': '#2ecc71',
    'CASH': '#f39c12',
}

CACHE_TTL = {
    'monthly_data': 3600,   # 1ì‹œê°„
    'etf_data': 86400,      # 24ì‹œê°„
}

DATA_LIMITS = {
    'etf_lookthrough_top_n': 10,
    'total_holdings_top_n': 20,
}

DB_PATH = "portfolio.db"
```

**ì‚¬ìš© ì˜ˆ:**
```python
from streamlit_app.config import COLORS, DB_PATH
```

---

### data_loader.py

**ì—­í• :** DB ë°ì´í„° ë¡œë”© ë° ìºì‹±

**ìºì‹± ì „ëµ:**
- `@st.cache_data(ttl=seconds)` ì‚¬ìš©
- TTL(Time To Live) ì„¤ì •ìœ¼ë¡œ ìë™ ë§Œë£Œ
- ê°™ì€ íŒŒë¼ë¯¸í„° ì¬ìš”ì²­ ì‹œ ìºì‹œ ë°˜í™˜

**ì£¼ìš” í•¨ìˆ˜:**

#### ê¸°ë³¸ ë°ì´í„°
```python
get_available_months() -> List[str]
get_latest_month() -> str
get_month_id(year_month) -> int
```

#### ì›”ë³„ ìš”ì•½
```python
get_monthly_summary(year_month) -> dict
# Returns: {
#     'total_value': int,
#     'total_invested': int,
#     'total_profit': int,
#     'return_rate': float
# }
```

#### ê³„ì¢Œ ë°ì´í„°
```python
get_accounts(year_month) -> List[dict]
get_account_holdings(year_month, account_id) -> pd.DataFrame
get_account_sectors(year_month, account_id) -> pd.DataFrame
get_etf_lookthrough(year_month, account_id, top_n) -> pd.DataFrame
```

#### ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤
```python
get_asset_type_summary(year_month) -> dict
get_hierarchical_portfolio_data(year_month) -> pd.DataFrame
search_total_holdings(year_month, ticker) -> dict
get_total_sectors(year_month, top_n) -> pd.DataFrame
get_total_top_holdings(year_month, top_n) -> pd.DataFrame
```

**DB ì¿¼ë¦¬ ì˜ˆ:**
```python
@st.cache_data(ttl=3600)
def get_monthly_summary(year_month: str) -> Dict:
    month_id = get_month_id(year_month)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT SUM(h.amount) as total_invested
        FROM holdings h
        JOIN accounts a ON h.account_id = a.id
        WHERE a.month_id = ?
    """, (month_id,))

    # ... ë°ì´í„° ì²˜ë¦¬

    conn.close()
    return result
```

---

### components/charts.py

**ì—­í• :** Plotly ì°¨íŠ¸ ìƒì„±

**ì£¼ìš” í•¨ìˆ˜:**

#### Waterfall Chart
```python
create_waterfall_chart(categories, values, title, height)
# ìì‚° ë³€ë™ íë¦„ ì‹œê°í™”
# [ì „ì›”] â†’ [ì…ê¸ˆ] â†’ [ì†ìµ] â†’ [ê¸ˆì›”]
```

#### Sunburst Chart
```python
create_sunburst_chart(df, title, height)
# ê³„ì¸µì  êµ¬ì¡° ì‹œê°í™”
# ROOT > ìì‚°ìœ í˜• > ì„¹í„° > ì¢…ëª©
```

#### Pie Chart
```python
create_pie_chart(df, labels_col, values_col, title, height)
# ì„¹í„° ë¹„ì¤‘ ë“±
```

#### Horizontal Bar Chart
```python
create_horizontal_bar_chart(df, x_col, y_col, title, height)
# ì„¹í„° ë¹„ì¤‘ (ë§‰ëŒ€)
```

#### Line Chart
```python
create_line_chart(df, x_col, y_col, title, height)
# ìì‚° ì¶”ì´
```

**ê³µí†µ íŒ¨í„´:**
```python
import plotly.graph_objects as go

def create_chart(...):
    fig = go.Figure(...)

    fig.update_layout(
        title=title,
        height=height,
        # ... ë ˆì´ì•„ì›ƒ ì„¤ì •
    )

    return fig
```

---

### pages/

**ì—­í• :** ê° í˜ì´ì§€ UI ë Œë”ë§

#### monthly_comparison.py
```python
def render(selected_month: str):
    st.header(f"ğŸ“… ì›”ë³„ íˆ¬ì ë¹„êµ - {selected_month}")

    # 1. Metric Cards
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("ì´ ìì‚°", ...)

    # 2. Waterfall Chart
    fig = create_waterfall_chart(...)
    st.plotly_chart(fig)

    # 3. ì›”ë³„ ë¹„êµ í…Œì´ë¸”
    df = get_recent_months_data(...)
    st.dataframe(df)
```

#### account_portfolio.py
```python
def render(selected_month: str):
    accounts = get_accounts(selected_month)

    for account in accounts:
        with st.expander(account['name']):
            tab1, tab2 = st.tabs(["ë³´ìœ  ì¢…ëª©", "ETF íˆ¬ì‹œ"])

            with tab1:
                # ë³´ìœ  ì¢…ëª© í…Œì´ë¸” + ì„¹í„° ì°¨íŠ¸

            with tab2:
                # ETF íˆ¬ì‹œ í† ê¸€ + ì¢…ëª© í…Œì´ë¸”
```

#### total_portfolio.py
```python
def render(selected_month: str):
    # 1. ìì‚° ìœ í˜•ë³„ ìš”ì•½
    # 2. Sunburst Chart
    # 3. ì¢…ëª© ê²€ìƒ‰
    # 4. ì„¹í„° ì°¨íŠ¸
    # 5. Top 20 Holdings
```

---

### utils/

#### formatters.py
```python
format_currency(value) -> str           # "1,234,567ì›"
format_percent(value, decimals) -> str  # "+5.2%"
format_shares(value) -> str             # "1.23ì£¼"
get_previous_month(year_month) -> str   # "2025-12" â†’ "2025-11"
get_next_month(year_month) -> str       # "2025-12" â†’ "2026-01"
```

#### state.py
```python
init_session_state()                    # ì„¸ì…˜ ì´ˆê¸°í™”
get_selected_month() -> str
set_selected_month(year_month)
```

---

## ìºì‹± ì „ëµ

### Streamlit ìºì‹± ë ˆë²¨

**1. ì •ì  ë°ì´í„° (7ì¼)**
```python
@st.cache_data(ttl=604800)
def get_available_months():
    # ìì£¼ ì•ˆ ë°”ë€ŒëŠ” ë°ì´í„°
```

**2. ì›”ë³„ ë°ì´í„° (1ì‹œê°„)**
```python
@st.cache_data(ttl=3600)
def get_monthly_summary(year_month):
    # ìì£¼ ì¡°íšŒí•˜ì§€ë§Œ ì‹¤ì‹œê°„ì„± í•„ìš” ì—†ìŒ
```

**3. ETF ë°ì´í„° (24ì‹œê°„)**
```python
@st.cache_data(ttl=86400)
def get_etf_lookthrough(year_month, account_id):
    # ì™¸ë¶€ API (yfinance) ì˜ì¡´ì 
```

### ìºì‹œ í‚¤

Streamlitì€ **í•¨ìˆ˜ëª… + íŒŒë¼ë¯¸í„°**ë¡œ ìºì‹œ í‚¤ ìƒì„±

```python
get_monthly_summary("2025-12")  # ìºì‹œ í‚¤ 1
get_monthly_summary("2025-11")  # ìºì‹œ í‚¤ 2 (ë‹¤ë¥¸ í‚¤)
```

### ìºì‹œ ë¬´íš¨í™”

**ìë™ ë¬´íš¨í™”:**
- TTL ë§Œë£Œ ì‹œ
- í•¨ìˆ˜ ì½”ë“œ ë³€ê²½ ì‹œ

**ìˆ˜ë™ ë¬´íš¨í™”:**
- ì•± ë©”ë‰´ > Clear cache
- `C` í‚¤ ëˆ„ë¥´ê¸°

---

## ì„±ëŠ¥ ìµœì í™”

### 1. ì¿¼ë¦¬ ìµœì í™”

**ì¸ë±ìŠ¤ í™œìš©:**
```sql
CREATE INDEX idx_months_year_month ON months(year_month);
CREATE INDEX idx_accounts_month ON accounts(month_id);
```

**JOIN ìµœì†Œí™”:**
```sql
-- Bad
SELECT * FROM holdings h
JOIN accounts a ON h.account_id = a.id
JOIN months m ON a.month_id = m.id
WHERE m.year_month = '2025-12';

-- Good
SELECT * FROM holdings h
WHERE h.account_id IN (
    SELECT id FROM accounts WHERE month_id = 123
);
```

### 2. Top N ì œí•œ

```python
# ì „ì²´ ì¡°íšŒ X
SELECT * FROM analyzed_holdings ORDER BY amount DESC;

# Top Në§Œ ì¡°íšŒ O
SELECT * FROM analyzed_holdings ORDER BY amount DESC LIMIT 10;
```

### 3. ì¡°ê±´ë¶€ ë Œë”ë§

```python
# ETF íˆ¬ì‹œ: í† ê¸€ OFF ì‹œ ë¡œë”© ì•ˆ í•¨
if not lookthrough_enabled:
    st.info("í† ê¸€ì„ ì¼œì„¸ìš”")
    return  # ë°ì´í„° ë¡œë”© ìƒëµ

# í† ê¸€ ON ì‹œì—ë§Œ ë¡œë”©
df = get_etf_lookthrough(...)
```

### 4. ì»¬ëŸ¼ ì„ íƒ

```python
# Bad: ì „ì²´ ì»¬ëŸ¼
SELECT * FROM holdings;

# Good: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ
SELECT name, amount, asset_type FROM holdings;
```

---

## í™•ì¥ ê°€ì´ë“œ

### ìƒˆ í˜ì´ì§€ ì¶”ê°€

**1. í˜ì´ì§€ íŒŒì¼ ìƒì„±**
```python
# streamlit_app/pages/my_new_page.py

def render(selected_month: str):
    st.header("ìƒˆ í˜ì´ì§€")
    # ... êµ¬í˜„
```

**2. app.pyì— ë¼ìš°íŒ… ì¶”ê°€**
```python
from streamlit_app.pages import my_new_page

# ì‚¬ì´ë“œë°”
page = st.radio("í˜ì´ì§€", [..., "ìƒˆ í˜ì´ì§€"])

# ë¼ìš°íŒ…
if page == "ìƒˆ í˜ì´ì§€":
    my_new_page.render(selected_month)
```

### ìƒˆ ì°¨íŠ¸ ì¶”ê°€

**1. charts.pyì— í•¨ìˆ˜ ì¶”ê°€**
```python
def create_my_chart(df, ...):
    fig = go.Figure(...)
    fig.update_layout(...)
    return fig
```

**2. í˜ì´ì§€ì—ì„œ ì‚¬ìš©**
```python
from streamlit_app.components.charts import create_my_chart

fig = create_my_chart(df)
st.plotly_chart(fig)
```

### ìƒˆ ë°ì´í„° í•¨ìˆ˜ ì¶”ê°€

**1. data_loader.pyì— í•¨ìˆ˜ ì¶”ê°€**
```python
@st.cache_data(ttl=3600)
def get_my_data(year_month: str) -> pd.DataFrame:
    month_id = get_month_id(year_month)

    conn = sqlite3.connect(DB_PATH)
    df = pd.read_sql_query("""
        SELECT ...
    """, conn, params=(month_id,))
    conn.close()

    return df
```

**2. í˜ì´ì§€ì—ì„œ í˜¸ì¶œ**
```python
df = get_my_data(selected_month)
```

---

## ë””ë²„ê¹… íŒ

### 1. ë¡œê·¸ í™•ì¸

```python
import streamlit as st

# ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
st.write("Debug:", data)

# ì—ëŸ¬ ì •ë³´ ì¶œë ¥
try:
    result = some_function()
except Exception as e:
    st.error(f"ì—ëŸ¬: {e}")
    st.exception(e)  # ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ì¶œë ¥
```

### 2. ìºì‹œ ìƒíƒœ í™•ì¸

```python
# ìºì‹œ í†µê³„
st.write(st.cache_data.get_stats())
```

### 3. ì„¸ì…˜ ìƒíƒœ í™•ì¸

```python
# ëª¨ë“  ì„¸ì…˜ ìƒíƒœ ì¶œë ¥
st.write("Session State:", st.session_state)
```

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. DB ì ‘ê·¼ ì œì–´

```python
# ì½ê¸° ì „ìš© ê¶Œí•œ
conn = sqlite3.connect(DB_PATH, uri=True, check_same_thread=False)
conn.execute("PRAGMA query_only = ON")
```

### 2. ì…ë ¥ ê²€ì¦

```python
# SQL ì¸ì ì…˜ ë°©ì§€ (íŒŒë¼ë¯¸í„° ë°”ì¸ë”©)
cursor.execute("SELECT * FROM months WHERE year_month = ?", (year_month,))
```

### 3. ì—ëŸ¬ ë©”ì‹œì§€

```python
# ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë°©ì§€
try:
    result = query_db()
except Exception as e:
    st.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨")  # êµ¬ì²´ì  ì—ëŸ¬ ìˆ¨ê¹€
    # ë¡œê·¸ì—ë§Œ ê¸°ë¡
    logger.error(f"DB Error: {e}")
```

---

**ì°¸ê³ :** ì´ ë¬¸ì„œëŠ” Streamlit ëŒ€ì‹œë³´ë“œì˜ ê¸°ìˆ ì  êµ¬ì¡°ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤. ì‚¬ìš© ë°©ë²•ì€ [README.md](./README.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
